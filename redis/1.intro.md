# redis

## intro

1. 基于内存
2. 用于实现缓存，读远多于写，数据大小不大
3. 用于高速读写
4. 分布式锁

## 数据类型

1. string，sds，有长度，不以'\0'结尾
2. hash，map
3. list，双向链表。阻塞队列
4. set，无序集合，哈希表、intset
5. zset，有序集合，跳表
6. hyperLogLogs，估计set中元素数量额概率性数据结构
7. bit arrays，可单独编辑bit的string

## 原子性

1. 分布式锁

## 数据超时

## 发布订阅

1. SUBSCRIBE foo bar
2. PUBLISH foo hello

## 持久化

1. RDB  快照，保存某一时刻数据，不管组过程。多长时间内有多少个数据被修改，则进行快照，记录结果
    父进程检测是否有子进程写如果没有就fork，然后干别的，等待子进程信号通知
2. AOF  append only file，默认不开启，将所有对数据库进行写入的命令记录到AOF文件，记录过程
    文件过大子进程后台自动重写，不阻塞主进程，子进程有数据副本，保证安全性，无锁
    可能数据不一致，AOF重写缓存，新的数据会住家到这个缓存里

RDB 性能高
RDB 改配置丢失最后一次快照后更改的数据
AOF 每秒保存一次，最多丢失2s
主服务器模式，RDB不会保存过期kv
从服务器模式，RDB会保存过期kv
AOF重写会忽略过期和del

rdb+aof
还原时优先用aof还原

## 缓存

缓存一致性

1. 双更问题，缓存和db先后更新都会有问题，db回滚、非原子
2. 删除模式，删除缓存，写数据库，先删会存在其他查询缓存击穿，仍然不一致。一般先写后删
    延迟双删。先写db，延迟几秒删cache

缓存穿透，key不存在，每次都查sql且缓存无法更新。
    布隆过滤器。缓存空结果，短过期
缓存雪崩，服务器重启或大量cache失效
    加锁队列，缓存失效时间随机值
缓存击穿，key有，但是cache过期。大并发压垮db
    热点key。
    用互斥锁失效时上锁，然后加在缓存

## 主从复制

避免单点故障。主写从读

数据同步：
全量rdb，增量aof

哨兵：
主节点探活，运行状况检测，自动故障转移，主从切换，配置提供者
主观下线：实例距离最后一次有效回复ping命令超过时限，标记为主观下线
         被标记为主观下线的实例，哨兵会定期ping，确认确实主观下线
客观下线：主观下线的实例被足够多的哨兵统一，则标记为客观下线

## redis集群

